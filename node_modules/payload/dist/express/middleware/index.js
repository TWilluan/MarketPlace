"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
Object.defineProperty(exports, "default", {
    enumerable: true,
    get: function() {
        return _default;
    }
});
const _bodyparser = /*#__PURE__*/ _interop_require_default(require("body-parser"));
const _compression = /*#__PURE__*/ _interop_require_default(require("compression"));
const _express = /*#__PURE__*/ _interop_require_default(require("express"));
const _expressfileupload = /*#__PURE__*/ _interop_require_default(require("express-fileupload"));
const _expressratelimit = /*#__PURE__*/ _interop_require_default(require("express-rate-limit"));
const _methodoverride = /*#__PURE__*/ _interop_require_default(require("method-override"));
const _passport = /*#__PURE__*/ _interop_require_default(require("passport"));
const _qsmiddleware = /*#__PURE__*/ _interop_require_default(require("qs-middleware"));
const _middleware = /*#__PURE__*/ _interop_require_default(require("../../localization/middleware"));
const _authenticate = /*#__PURE__*/ _interop_require_default(require("./authenticate"));
const _convertPayload = /*#__PURE__*/ _interop_require_default(require("./convertPayload"));
const _corsHeaders = /*#__PURE__*/ _interop_require_default(require("./corsHeaders"));
const _defaultPayload = /*#__PURE__*/ _interop_require_default(require("./defaultPayload"));
const _i18n = require("./i18n");
const _identifyAPI = /*#__PURE__*/ _interop_require_default(require("./identifyAPI"));
function _interop_require_default(obj) {
    return obj && obj.__esModule ? obj : {
        default: obj
    };
}
const middleware = (payload)=>{
    const rateLimitOptions = {
        max: payload.config.rateLimit.max,
        windowMs: payload.config.rateLimit.window
    };
    if (typeof payload.config.rateLimit.skip === 'function') rateLimitOptions.skip = payload.config.rateLimit.skip;
    if (payload.config.express.middleware?.length) {
        payload.logger.warn('express.middleware is deprecated. Please migrate to express.postMiddleware.');
    }
    return [
        _defaultPayload.default,
        ...payload.config.express.preMiddleware || [],
        (0, _expressratelimit.default)(rateLimitOptions),
        _passport.default.initialize(),
        (0, _i18n.i18nMiddleware)(payload.config.i18n),
        (0, _identifyAPI.default)('REST'),
        (0, _methodoverride.default)('X-HTTP-Method-Override'),
        (0, _qsmiddleware.default)({
            arrayLimit: 1000,
            depth: 10,
            strictNullHandling: true
        }),
        _bodyparser.default.urlencoded({
            extended: true
        }),
        (0, _compression.default)(payload.config.express.compression),
        _middleware.default,
        _express.default.json(payload.config.express.json),
        (0, _expressfileupload.default)({
            parseNested: true,
            ...payload.config.upload
        }),
        _convertPayload.default,
        (0, _authenticate.default)(payload.config),
        (0, _corsHeaders.default)(payload.config),
        ...payload.config.express.middleware || [],
        ...payload.config.express.postMiddleware || []
    ];
};
const _default = middleware;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9leHByZXNzL21pZGRsZXdhcmUvaW5kZXgudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGJvZHlQYXJzZXIgZnJvbSAnYm9keS1wYXJzZXInXG5pbXBvcnQgY29tcHJlc3Npb24gZnJvbSAnY29tcHJlc3Npb24nXG5pbXBvcnQgZXhwcmVzcyBmcm9tICdleHByZXNzJ1xuaW1wb3J0IGZpbGVVcGxvYWQgZnJvbSAnZXhwcmVzcy1maWxldXBsb2FkJ1xuaW1wb3J0IHJhdGVMaW1pdCBmcm9tICdleHByZXNzLXJhdGUtbGltaXQnXG5pbXBvcnQgbWV0aG9kT3ZlcnJpZGUgZnJvbSAnbWV0aG9kLW92ZXJyaWRlJ1xuaW1wb3J0IHBhc3Nwb3J0IGZyb20gJ3Bhc3Nwb3J0J1xuaW1wb3J0IHFzTWlkZGxld2FyZSBmcm9tICdxcy1taWRkbGV3YXJlJ1xuXG5pbXBvcnQgdHlwZSB7IFBheWxvYWQgfSBmcm9tICcuLi8uLi9wYXlsb2FkJ1xuaW1wb3J0IHR5cGUgeyBQYXlsb2FkUmVxdWVzdCB9IGZyb20gJy4uL3R5cGVzJ1xuXG5pbXBvcnQgbG9jYWxpemF0aW9uTWlkZGxld2FyZSBmcm9tICcuLi8uLi9sb2NhbGl6YXRpb24vbWlkZGxld2FyZSdcbmltcG9ydCBhdXRoZW50aWNhdGUgZnJvbSAnLi9hdXRoZW50aWNhdGUnXG5pbXBvcnQgY29udmVydFBheWxvYWQgZnJvbSAnLi9jb252ZXJ0UGF5bG9hZCdcbmltcG9ydCBjb3JzSGVhZGVycyBmcm9tICcuL2NvcnNIZWFkZXJzJ1xuaW1wb3J0IGRlZmF1bHRQYXlsb2FkIGZyb20gJy4vZGVmYXVsdFBheWxvYWQnXG5pbXBvcnQgeyBpMThuTWlkZGxld2FyZSB9IGZyb20gJy4vaTE4bidcbmltcG9ydCBpZGVudGlmeUFQSSBmcm9tICcuL2lkZW50aWZ5QVBJJ1xuXG5jb25zdCBtaWRkbGV3YXJlID0gKHBheWxvYWQ6IFBheWxvYWQpOiBhbnkgPT4ge1xuICBjb25zdCByYXRlTGltaXRPcHRpb25zOiB7XG4gICAgbWF4PzogbnVtYmVyXG4gICAgc2tpcD86IChyZXE6IFBheWxvYWRSZXF1ZXN0KSA9PiBib29sZWFuXG4gICAgd2luZG93TXM/OiBudW1iZXJcbiAgfSA9IHtcbiAgICBtYXg6IHBheWxvYWQuY29uZmlnLnJhdGVMaW1pdC5tYXgsXG4gICAgd2luZG93TXM6IHBheWxvYWQuY29uZmlnLnJhdGVMaW1pdC53aW5kb3csXG4gIH1cblxuICBpZiAodHlwZW9mIHBheWxvYWQuY29uZmlnLnJhdGVMaW1pdC5za2lwID09PSAnZnVuY3Rpb24nKVxuICAgIHJhdGVMaW1pdE9wdGlvbnMuc2tpcCA9IHBheWxvYWQuY29uZmlnLnJhdGVMaW1pdC5za2lwXG5cbiAgaWYgKHBheWxvYWQuY29uZmlnLmV4cHJlc3MubWlkZGxld2FyZT8ubGVuZ3RoKSB7XG4gICAgcGF5bG9hZC5sb2dnZXIud2FybihcbiAgICAgICdleHByZXNzLm1pZGRsZXdhcmUgaXMgZGVwcmVjYXRlZC4gUGxlYXNlIG1pZ3JhdGUgdG8gZXhwcmVzcy5wb3N0TWlkZGxld2FyZS4nLFxuICAgIClcbiAgfVxuXG4gIHJldHVybiBbXG4gICAgZGVmYXVsdFBheWxvYWQsXG4gICAgLi4uKHBheWxvYWQuY29uZmlnLmV4cHJlc3MucHJlTWlkZGxld2FyZSB8fCBbXSksXG4gICAgcmF0ZUxpbWl0KHJhdGVMaW1pdE9wdGlvbnMpLFxuICAgIHBhc3Nwb3J0LmluaXRpYWxpemUoKSxcbiAgICBpMThuTWlkZGxld2FyZShwYXlsb2FkLmNvbmZpZy5pMThuKSxcbiAgICBpZGVudGlmeUFQSSgnUkVTVCcpLFxuICAgIG1ldGhvZE92ZXJyaWRlKCdYLUhUVFAtTWV0aG9kLU92ZXJyaWRlJyksXG4gICAgcXNNaWRkbGV3YXJlKHsgYXJyYXlMaW1pdDogMTAwMCwgZGVwdGg6IDEwLCBzdHJpY3ROdWxsSGFuZGxpbmc6IHRydWUgfSksXG4gICAgYm9keVBhcnNlci51cmxlbmNvZGVkKHsgZXh0ZW5kZWQ6IHRydWUgfSksXG4gICAgY29tcHJlc3Npb24ocGF5bG9hZC5jb25maWcuZXhwcmVzcy5jb21wcmVzc2lvbiksXG4gICAgbG9jYWxpemF0aW9uTWlkZGxld2FyZSxcbiAgICBleHByZXNzLmpzb24ocGF5bG9hZC5jb25maWcuZXhwcmVzcy5qc29uKSxcbiAgICBmaWxlVXBsb2FkKHtcbiAgICAgIHBhcnNlTmVzdGVkOiB0cnVlLFxuICAgICAgLi4ucGF5bG9hZC5jb25maWcudXBsb2FkLFxuICAgIH0pLFxuICAgIGNvbnZlcnRQYXlsb2FkLFxuICAgIGF1dGhlbnRpY2F0ZShwYXlsb2FkLmNvbmZpZyksXG4gICAgY29yc0hlYWRlcnMocGF5bG9hZC5jb25maWcpLFxuICAgIC4uLihwYXlsb2FkLmNvbmZpZy5leHByZXNzLm1pZGRsZXdhcmUgfHwgW10pLFxuICAgIC4uLihwYXlsb2FkLmNvbmZpZy5leHByZXNzLnBvc3RNaWRkbGV3YXJlIHx8IFtdKSxcbiAgXVxufVxuXG5leHBvcnQgZGVmYXVsdCBtaWRkbGV3YXJlXG4iXSwibmFtZXMiOlsibWlkZGxld2FyZSIsInBheWxvYWQiLCJyYXRlTGltaXRPcHRpb25zIiwibWF4IiwiY29uZmlnIiwicmF0ZUxpbWl0Iiwid2luZG93TXMiLCJ3aW5kb3ciLCJza2lwIiwiZXhwcmVzcyIsImxlbmd0aCIsImxvZ2dlciIsIndhcm4iLCJkZWZhdWx0UGF5bG9hZCIsInByZU1pZGRsZXdhcmUiLCJwYXNzcG9ydCIsImluaXRpYWxpemUiLCJpMThuTWlkZGxld2FyZSIsImkxOG4iLCJpZGVudGlmeUFQSSIsIm1ldGhvZE92ZXJyaWRlIiwicXNNaWRkbGV3YXJlIiwiYXJyYXlMaW1pdCIsImRlcHRoIiwic3RyaWN0TnVsbEhhbmRsaW5nIiwiYm9keVBhcnNlciIsInVybGVuY29kZWQiLCJleHRlbmRlZCIsImNvbXByZXNzaW9uIiwibG9jYWxpemF0aW9uTWlkZGxld2FyZSIsImpzb24iLCJmaWxlVXBsb2FkIiwicGFyc2VOZXN0ZWQiLCJ1cGxvYWQiLCJjb252ZXJ0UGF5bG9hZCIsImF1dGhlbnRpY2F0ZSIsImNvcnNIZWFkZXJzIiwicG9zdE1pZGRsZXdhcmUiXSwicmFuZ2VNYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OyIsIm1hcHBpbmdzIjoiOzs7OytCQWdFQTs7O2VBQUE7OzttRUFoRXVCO29FQUNDO2dFQUNKOzBFQUNHO3lFQUNEO3VFQUNLO2lFQUNOO3FFQUNJO21FQUtVO3FFQUNWO3VFQUNFO29FQUNIO3VFQUNHO3NCQUNJO29FQUNQOzs7Ozs7QUFFeEIsTUFBTUEsYUFBYSxDQUFDQztJQUNsQixNQUFNQyxtQkFJRjtRQUNGQyxLQUFLRixRQUFRRyxNQUFNLENBQUNDLFNBQVMsQ0FBQ0YsR0FBRztRQUNqQ0csVUFBVUwsUUFBUUcsTUFBTSxDQUFDQyxTQUFTLENBQUNFLE1BQU07SUFDM0M7SUFFQSxJQUFJLE9BQU9OLFFBQVFHLE1BQU0sQ0FBQ0MsU0FBUyxDQUFDRyxJQUFJLEtBQUssWUFDM0NOLGlCQUFpQk0sSUFBSSxHQUFHUCxRQUFRRyxNQUFNLENBQUNDLFNBQVMsQ0FBQ0csSUFBSTtJQUV2RCxJQUFJUCxRQUFRRyxNQUFNLENBQUNLLE9BQU8sQ0FBQ1QsVUFBVSxFQUFFVSxRQUFRO1FBQzdDVCxRQUFRVSxNQUFNLENBQUNDLElBQUksQ0FDakI7SUFFSjtJQUVBLE9BQU87UUFDTEMsdUJBQWM7V0FDVlosUUFBUUcsTUFBTSxDQUFDSyxPQUFPLENBQUNLLGFBQWEsSUFBSSxFQUFFO1FBQzlDVCxJQUFBQSx5QkFBUyxFQUFDSDtRQUNWYSxpQkFBUSxDQUFDQyxVQUFVO1FBQ25CQyxJQUFBQSxvQkFBYyxFQUFDaEIsUUFBUUcsTUFBTSxDQUFDYyxJQUFJO1FBQ2xDQyxJQUFBQSxvQkFBVyxFQUFDO1FBQ1pDLElBQUFBLHVCQUFjLEVBQUM7UUFDZkMsSUFBQUEscUJBQVksRUFBQztZQUFFQyxZQUFZO1lBQU1DLE9BQU87WUFBSUMsb0JBQW9CO1FBQUs7UUFDckVDLG1CQUFVLENBQUNDLFVBQVUsQ0FBQztZQUFFQyxVQUFVO1FBQUs7UUFDdkNDLElBQUFBLG9CQUFXLEVBQUMzQixRQUFRRyxNQUFNLENBQUNLLE9BQU8sQ0FBQ21CLFdBQVc7UUFDOUNDLG1CQUFzQjtRQUN0QnBCLGdCQUFPLENBQUNxQixJQUFJLENBQUM3QixRQUFRRyxNQUFNLENBQUNLLE9BQU8sQ0FBQ3FCLElBQUk7UUFDeENDLElBQUFBLDBCQUFVLEVBQUM7WUFDVEMsYUFBYTtZQUNiLEdBQUcvQixRQUFRRyxNQUFNLENBQUM2QixNQUFNO1FBQzFCO1FBQ0FDLHVCQUFjO1FBQ2RDLElBQUFBLHFCQUFZLEVBQUNsQyxRQUFRRyxNQUFNO1FBQzNCZ0MsSUFBQUEsb0JBQVcsRUFBQ25DLFFBQVFHLE1BQU07V0FDdEJILFFBQVFHLE1BQU0sQ0FBQ0ssT0FBTyxDQUFDVCxVQUFVLElBQUksRUFBRTtXQUN2Q0MsUUFBUUcsTUFBTSxDQUFDSyxPQUFPLENBQUM0QixjQUFjLElBQUksRUFBRTtLQUNoRDtBQUNIO01BRUEsV0FBZXJDIn0=